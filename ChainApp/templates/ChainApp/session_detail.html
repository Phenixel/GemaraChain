{% extends 'base.html' %}
{% load static %}

{% block title %}{{ session.name }}{% endblock %}

{% block css %}
    <link rel="stylesheet" href="{% static 'css/sessions.css' %}">
{% endblock %}

{% block scripts %}
    <script src="{% static 'js/sessions.js' %}"></script>
{% endblock %}

{% block header %}
    <div class="hero-header text-center">
        <h1 class="display-3">{{ session.name }}</h1>
        <p>Session créée par : {{ session.person }}</p>
        <p>{{ session.description }}</p>
        <p>Date limite: {{ session.date_limit }}</p>
    </div>
{% endblock %}

{% block content %}
    {% if is_expired %}
        <div class="alert alert-danger" role="alert">
            Cette session est expirée et vous ne pouvez plus effectuer de réservations.
        </div>
    {% endif %}

    <div class="content-page mb-5 sticky-container">
        <form method="post">
            {% csrf_token %}

            <div class="row mb-4 sticky-top form-reservation">
                {% if not user.is_authenticated %}
                    {% if not is_expired %}
                        <div class="col-md-5">
                            <div class="form-group">
                                <label for="guest_name">Nom</label>
                                <input type="text" class="form-control" id="guest_name" name="guest_name" required>
                            </div>
                        </div>
                        <div class="col-md-5">
                            <div class="form-group">
                                <label for="guest_email">Email</label>
                                <input type="email" class="form-control" id="guest_email" name="guest_email" required
                                       data-bs-toggle="popover" data-bs-trigger="focus" title="Information sur l'email"
                                       data-bs-placement="top"
                                       data-bs-content="Votre email ne sera pas utilisé à des fins commerciales. Il servira uniquement à vous prévenir de la date limite de la session.">
                            </div>
                        </div>
                    {% endif %}
                {% endif %}
                <div class="d-flex align-items-end
                {% if not user.is_authenticated %}col-md-2{% else %}col-md-12{% endif %}">
                    <button type="submit" class="btn btn-primary w-100" {% if is_expired %}disabled{% endif %}>
                        Réserver
                    </button>
                </div>
            </div>

            <div class="mb-3">
                <small>
                    Cochez les cases pour réserver un perek ou une massekhet. Si vous avez déjà réservé un perek ou une
                    massekhet, vous pouvez le décocher pour annuler votre réservation (si vous avez un compte).
                    Cliquez sur la carte de la gemara ou de la massekhet pour voir les perekim disponibles.
                </small>
            </div>

            {% if gemarot_list %}
                <div class="row">
                    {% for item in gemarot_list %}
                        <div class="col-md-4">
                            <div class="card mb-4 card-lecture">
                                <div class="card-body position-relative">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="gemara_{{ item.gemara.pk }}"
                                               name="gemarot" value="{{ item.gemara.pk }}"
                                               {% if item.all_perek_reserved_by_user %}checked{% endif %}
                                               {% if item.all_perek_reserved and not item.reserved_by_user or is_expired %}disabled{% endif %}
                                               onchange="togglePerekSelection('{{ item.gemara.pk }}', this.checked)">
                                        <label class="form-check-label" for="gemara_{{ item.gemara.pk }}">
                                            <a href="{{ item.gemara.link }}" style="text-decoration: none"
                                               target="_blank">{{ item.gemara.name }}</a>

                                            {% if item.all_perek_reserved %}
                                                <span>
                                                    Réservé
                                                </span>
                                            {% elif item.some_perek_reserved %}
                                                <span>
                                                    En cours
                                                </span>
                                            {% endif %}
                                        </label>

                                        <div id="perek_list_{{ item.gemara.pk }}" class="perek-list"
                                             style="display:none;">
                                            <div class="ml-3">
                                                {% for perek in item.perekim %}
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox"
                                                               id="perek_{{ item.gemara.pk }}-{{ perek.perek }}"
                                                               name="perekim"
                                                               value="{{ item.gemara.pk }}-{{ perek.perek }}"
                                                                {% if perek.reserved_by_user %}
                                                               checked
                                                                {% endif %}
                                                                {% if perek.reserved and not perek.reserved_by_user or is_expired %}
                                                               disabled
                                                                {% endif %}>
                                                        <label class="form-check-label"
                                                               for="perek_{{ item.gemara.pk }}-{{ perek.perek }}">
                                                            Perek {{ perek.perek }}
                                                            {% if perek.reserved %}
                                                                <span>
                                                                    Réservé par {{ perek.chosen_by_username }}
                                                                </span>
                                                            {% endif %}
                                                        </label>
                                                    </div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="collapse-icon" style="display: none; cursor:pointer;">&#9650;</div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            {% endif %}

            {% if seder_list %}
                {% for seder_data in seder_list %}
                    <div class="col-md-12 mb-3">
                        <h3>{{ seder_data.seder.name }}</h3>
                        <div class="row">
                            {% for item in seder_data.massekhtot %}
                                <div class="col-md-4">
                                    <div class="card mb-4 card-lecture">
                                        <div class="card-body position-relative">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox"
                                                       id="masekhet_{{ item.masekhet.pk }}" name="masekhtot"
                                                       value="{{ item.masekhet.pk }}"
                                                        {% if item.all_perek_reserved_by_user %}
                                                       checked
                                                        {% endif %}
                                                        {% if item.all_perek_reserved and not item.reserved_by_user or is_expired %}
                                                       disabled
                                                        {% endif %}
                                                       onchange="togglePerekSelection('{{ item.masekhet.pk }}', this.checked)">
                                                <label class="form-check-label" for="masekhet_{{ item.masekhet.pk }}">
                                                    {{ item.masekhet.name }}

                                                    {% if item.all_perek_reserved %}
                                                        <span>
                                                            Réservé
                                                        </span>
                                                    {% elif item.some_perek_reserved %}
                                                        <span>
                                                            En cours
                                                        </span>
                                                    {% endif %}
                                                </label>

                                                <div id="perek_list_{{ item.masekhet.pk }}" class="perek-list"
                                                     style="display:none;">
                                                    <div class="ml-3">
                                                        {% for perek in item.perekim %}
                                                            <div class="form-check">
                                                                <input class="form-check-input" type="checkbox"
                                                                       id="perek_{{ item.masekhet.pk }}-{{ perek.perek }}"
                                                                       name="perekim"
                                                                       value="{{ item.masekhet.pk }}-{{ perek.perek }}"
                                                                        {% if perek.reserved_by_user %}
                                                                       checked
                                                                        {% endif %}
                                                                        {% if perek.reserved and not perek.reserved_by_user or is_expired %}
                                                                       disabled
                                                                        {% endif %}>
                                                                <label class="form-check-label"
                                                                       for="perek_{{ item.masekhet.pk }}-{{ perek.perek }}">
                                                                    Perek {{ perek.perek }}
                                                                    {% if perek.reserved %}
                                                                        <span>
                                                                            Réservé par {{ perek.chosen_by_username }}
                                                                        </span>
                                                                    {% endif %}
                                                                </label>
                                                            </div>
                                                        {% endfor %}
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="collapse-icon" style="display: none; cursor:pointer;">&#9650;
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                {% endfor %}
            {% endif %}
        </form>
        <div class="text-center mt-5">
            <a href="{% url 'home' %}" style="text-decoration: none">Créer votre propre session en cliquant ici</a>
        </div>
    </div>

    {% if not user.is_authenticated %}
        <div class="content-page">
            <div class="hero-header">
                <h3>Pourquoi se créer un compte ?</h3>
                <div class="text-start">
                    <p>Créer un compte vous permet de :</p>
                    <ul>
                        <li>Créer des sessions d'études</li>
                        <li>Rejoindre des sessions d'études</li>
                        <li>Connaître les dates limites des sessions d'études</li>
                    </ul>
                    <a href="{% url 'signup' %}" class="btn btn-primary">Créer un compte</a>
                </div>
            </div>
        </div>
    {% endif %}
{% endblock %}